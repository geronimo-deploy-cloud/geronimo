# Azure DevOps Pipeline for test-ml-project
# Generated by Geronimo

trigger:
  branches:
    include:
      - main
      - develop
  paths:
    exclude:
      - '*.md'
      - 'docs/**'

pr:
  branches:
    include:
      - main
      - develop

variables:
  - name: projectName
    value: 'test-ml-project'
  - name: pythonVersion
    value: '3.11'
  - name: AWS_REGION
    value: 'us-east-1'

stages:
  # ============================================================================
  # Build & Test Stage
  # ============================================================================
  - stage: Build
    displayName: 'Build & Test'
    jobs:
      - job: BuildAndTest
        displayName: 'Build and Test'
        pool:
          vmImage: 'ubuntu-latest'

        steps:
          - task: UsePythonVersion@0
            displayName: 'Set up Python'
            inputs:
              versionSpec: '$(pythonVersion)'

          - script: |
              curl -LsSf https://astral.sh/uv/install.sh | sh
              echo "##vso[task.prependpath]$HOME/.local/bin"
            displayName: 'Install uv'

          - script: |
              uv sync
            displayName: 'Install dependencies'

          - script: |
              uv run pytest tests/ -v --junitxml=test-results.xml --cov=src --cov-report=xml
            displayName: 'Run tests'

          - task: PublishTestResults@2
            displayName: 'Publish test results'
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: 'test-results.xml'
            condition: always()

          - task: PublishCodeCoverageResults@1
            displayName: 'Publish coverage'
            inputs:
              codeCoverageTool: 'Cobertura'
              summaryFileLocation: 'coverage.xml'
            condition: always()

  # ============================================================================
  # Security Scan Stage
  # ============================================================================
  - stage: Security
    displayName: 'Security Scan'
    dependsOn: Build
    jobs:
      - job: SecurityScan
        displayName: 'Security Scanning'
        pool:
          vmImage: 'ubuntu-latest'

        steps:
          - task: UsePythonVersion@0
            inputs:
              versionSpec: '$(pythonVersion)'

          - script: |
              pip install safety bandit
            displayName: 'Install security tools'

          - script: |
              safety check --file pyproject.toml || true
            displayName: 'Check dependency vulnerabilities'

          - script: |
              bandit -r src/ -f json -o bandit-report.json || true
            displayName: 'Run static security analysis'

          - task: PublishBuildArtifacts@1
            displayName: 'Publish security reports'
            inputs:
              pathToPublish: 'bandit-report.json'
              artifactName: 'security-reports'
            condition: always()

  # ============================================================================
  # Docker Build Stage
  # ============================================================================
  - stage: Docker
    displayName: 'Build Docker Image'
    dependsOn: Security
    jobs:
      - job: DockerBuild
        displayName: 'Build and Push Image'
        pool:
          vmImage: 'ubuntu-latest'

        steps:
          - task: AWSShellScript@1
            displayName: 'Login to ECR'
            inputs:
              awsCredentials: 'AWS-Connection'
              regionName: '$(AWS_REGION)'
              scriptType: 'inline'
              inlineScript: |
                aws ecr get-login-password --region $(AWS_REGION) | \
                  podman login --username AWS --password-stdin \
                  $(aws sts get-caller-identity --query Account --output text).dkr.ecr.$(AWS_REGION).amazonaws.com

          - script: |
              IMAGE_TAG=$(Build.BuildNumber)
              ECR_REPO=$(projectName)

              podman build -t $ECR_REPO:$IMAGE_TAG -t $ECR_REPO:latest .

              echo "##vso[task.setvariable variable=imageTag;isOutput=true]$IMAGE_TAG"
            displayName: 'Build Docker image'
            name: dockerBuild

          - task: AWSShellScript@1
            displayName: 'Push to ECR'
            inputs:
              awsCredentials: 'AWS-Connection'
              regionName: '$(AWS_REGION)'
              scriptType: 'inline'
              inlineScript: |
                ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
                ECR_URI=$ACCOUNT_ID.dkr.ecr.$(AWS_REGION).amazonaws.com

                podman push $(projectName):$(Build.BuildNumber) $ECR_URI/$(projectName):$(Build.BuildNumber)
                podman push $(projectName):latest $ECR_URI/$(projectName):latest


  # ============================================================================
  # Deploy to Dev
  # ============================================================================
  - stage: DeployDev
    displayName: 'Deploy to Dev'
    dependsOn: Docker
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - deployment: DeployDev
        displayName: 'Deploy to Dev'
        pool:
          vmImage: 'ubuntu-latest'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: AWSShellScript@1
                  displayName: 'Update ECS Service'
                  inputs:
                    awsCredentials: 'AWS-Connection-DEV'
                    regionName: '$(AWS_REGION)'
                    scriptType: 'inline'
                    inlineScript: |
                      aws ecs update-service \
                        --cluster $(projectName)-dev \
                        --service $(projectName) \
                        --force-new-deployment

                - task: AWSShellScript@1
                  displayName: 'Wait for deployment'
                  inputs:
                    awsCredentials: 'AWS-Connection-DEV'
                    regionName: '$(AWS_REGION)'
                    scriptType: 'inline'
                    inlineScript: |
                      aws ecs wait services-stable \
                        --cluster $(projectName)-dev \
                        --services $(projectName)

                - script: |
                    echo "Deployment to dev completed successfully"
                  displayName: 'Deployment complete' 

  # ============================================================================
  # Deploy to Prod
  # ============================================================================
  - stage: DeployProd
    displayName: 'Deploy to Prod'
    dependsOn: Dev
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - deployment: DeployProd
        displayName: 'Deploy to Prod'
        pool:
          vmImage: 'ubuntu-latest'
        environment: 'test-ml-project-prod'  # Requires approval in ADO
        strategy:
          runOnce:
            deploy:
              steps:
                - task: AWSShellScript@1
                  displayName: 'Update ECS Service'
                  inputs:
                    awsCredentials: 'AWS-Connection-PROD'
                    regionName: '$(AWS_REGION)'
                    scriptType: 'inline'
                    inlineScript: |
                      aws ecs update-service \
                        --cluster $(projectName)-prod \
                        --service $(projectName) \
                        --force-new-deployment

                - task: AWSShellScript@1
                  displayName: 'Wait for deployment'
                  inputs:
                    awsCredentials: 'AWS-Connection-PROD'
                    regionName: '$(AWS_REGION)'
                    scriptType: 'inline'
                    inlineScript: |
                      aws ecs wait services-stable \
                        --cluster $(projectName)-prod \
                        --services $(projectName)

                - script: |
                    echo "Deployment to prod completed successfully"
                  displayName: 'Deployment complete' 
